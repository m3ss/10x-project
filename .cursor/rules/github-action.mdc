# GitHub Actions - ReguÅ‚y i Best Practices

## OgÃ³lne zasady

### Struktura workflow

- Wszystkie workflow GitHub Actions powinny byÄ‡ umieszczone w katalogu `.github/workflows/`
- UÅ¼ywaj rozszerzenia `.yml` lub `.yaml` dla plikÃ³w workflow
- Nazwij pliki workflow opisowo, zgodnie z ich przeznaczeniem (np. `pull-request.yml`, `deploy.yml`)

### Wersjonowanie akcji

- Zawsze uÅ¼ywaj konkretnych wersji akcji (np. `actions/checkout@v4`) zamiast `@latest`
- Preferuj najnowsze stabilne wersje oficjalnych akcji GitHub
- Regularnie aktualizuj wersje akcji do najnowszych stabilnych

### Node.js setup

```yaml
- name: Setup Node.js
  uses: actions/setup-node@v4
  with:
    node-version: '20'
    cache: 'npm'
```

### Instalacja zaleÅ¼noÅ›ci

- UÅ¼ywaj `npm ci` zamiast `npm install` dla powtarzalnych buildÃ³w
- WÅ‚Ä…cz cache'owanie zaleÅ¼noÅ›ci dla szybszych buildÃ³w

## Workflow dla Pull RequestÃ³w

### Podstawowa struktura

```yaml
name: Pull Request CI

on:
  pull_request:
    branches:
      - master
      - main
      - develop
```

### Jobs i kolejnoÅ›Ä‡ wykonania

1. **Linting** - pierwsza warstwa walidacji
   - ESLint dla JavaScript/TypeScript
   - Prettier dla formatowania (opcjonalnie)

2. **Unit Tests** - testy jednostkowe
   - Uruchamianie z coverage
   - Wymaga sukcesu lintingu (`needs: lint`)

3. **E2E Tests** (opcjonalnie)
   - Testy end-to-end
   - Wymaga sukcesu testÃ³w jednostkowych

4. **Status Comment** - komentarz podsumowujÄ…cy
   - Uruchamia siÄ™ tylko gdy wszystkie poprzednie joby zakoÅ„czÄ… siÄ™ sukcesem
   - Wymaga `needs: [lint, unit-test]`
   - Warunek: `if: always() && needs.lint.result == 'success' && needs.unit-test.result == 'success'`

### PrzykÅ‚ad job linting

```yaml
lint:
  name: Lint Code
  runs-on: ubuntu-latest
  
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run ESLint
      run: npm run lint
```

### PrzykÅ‚ad job testÃ³w jednostkowych z coverage

```yaml
unit-test:
  name: Unit Tests
  runs-on: ubuntu-latest
  needs: lint
  
  steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Run unit tests with coverage
      run: npm run test:unit:coverage
    
    - name: Upload coverage reports
      uses: codecov/codecov-action@v4
      if: always()
      with:
        token: ${{ secrets.CODECOV_TOKEN }}
        files: ./coverage/coverage-final.json
        flags: unittests
        name: codecov-umbrella
        fail_ci_if_error: false
    
    - name: Archive coverage artifacts
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: coverage-report
        path: coverage/
        retention-days: 30
```

### Status Comment Job

```yaml
status-comment:
  name: PR Status Comment
  runs-on: ubuntu-latest
  needs: [lint, unit-test]
  if: always() && needs.lint.result == 'success' && needs.unit-test.result == 'success'
  
  permissions:
    pull-requests: write
  
  steps:
    - name: Download coverage artifacts
      uses: actions/download-artifact@v4
      with:
        name: coverage-report
        path: coverage/
    
    - name: Extract coverage summary
      id: coverage
      run: |
        if [ -f "coverage/coverage-summary.json" ]; then
          COVERAGE=$(cat coverage/coverage-summary.json | jq -r '.total.lines.pct')
          echo "percentage=$COVERAGE" >> $GITHUB_OUTPUT
        else
          echo "percentage=N/A" >> $GITHUB_OUTPUT
        fi
    
    - name: Comment PR with status
      uses: actions/github-script@v7
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const coverage = '${{ steps.coverage.outputs.percentage }}';
          const body = `## âœ… Pull Request CI - Success
          
          ### ğŸ“Š Summary
          | Job | Status |
          |-----|--------|
          | ğŸ” Lint | âœ… Passed |
          | ğŸ§ª Unit Tests | âœ… Passed |
          | ğŸ“ˆ Coverage | ${coverage}% |
          `;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: body
          });
```

## Coverage Reports

### Vitest Coverage

- UÅ¼yj komendy: `npm run test:unit:coverage`
- Wygenerowane pliki coverage znajdujÄ… siÄ™ w katalogu `coverage/`
- Format raportÃ³w: JSON, HTML, text

### Integracja z Codecov

- Wymaga ustawienia `CODECOV_TOKEN` w secrets repozytorium
- Akcja: `codecov/codecov-action@v4`
- Flagi dla rÃ³Å¼nych typÃ³w testÃ³w: `unittests`, `e2etests`

### Artifacts

- Zapisuj raporty coverage jako artifacts dla pÃ³Åºniejszej analizy
- Retention period: 30 dni (dostosuj wedÅ‚ug potrzeb)
- UÅ¼ywaj `actions/upload-artifact@v4` i `actions/download-artifact@v4`

## Uprawnienia (Permissions)

### Pull Requests Comments

```yaml
permissions:
  pull-requests: write
```

### Wszystkie operacje

```yaml
permissions:
  contents: read
  pull-requests: write
  checks: write
```

## Best Practices

1. **Dependency Caching**: Zawsze uÅ¼ywaj cache dla zaleÅ¼noÅ›ci npm
2. **Fail Fast**: Zatrzymuj workflow gdy lint failuje (uÅ¼ywaj `needs`)
3. **Conditional Execution**: UÅ¼ywaj `if` dla warunkowych krokÃ³w
4. **Secrets Management**: Nigdy nie commituj secrets, uÅ¼ywaj GitHub Secrets
5. **Matrix Strategy**: Dla testÃ³w na rÃ³Å¼nych wersjach Node.js uÅ¼yj matrix
6. **Timeout**: Ustaw rozsÄ…dne timeouty dla jobÃ³w (`timeout-minutes: 10`)
7. **Artifacts**: Zachowuj waÅ¼ne artefakty (coverage, test results) dla analizy

## Environment Variables

### Vitest

```yaml
env:
  NODE_ENV: test
  VITEST_COVERAGE: true
```

### Supabase (jeÅ›li potrzebne)

```yaml
env:
  SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
  SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
```

## Troubleshooting

### Coverage nie jest generowane

- SprawdÅº czy w `package.json` jest skrypt `test:unit:coverage`
- Upewnij siÄ™ Å¼e `@vitest/coverage-v8` jest zainstalowane
- Zweryfikuj konfiguracjÄ™ `vitest.config.ts`

### Status comment nie pojawia siÄ™

- SprawdÅº czy workflow ma uprawnienia `pull-requests: write`
- Zweryfikuj warunek `if` w job `status-comment`
- Upewnij siÄ™ Å¼e `GITHUB_TOKEN` jest dostÄ™pny

### Artifacts nie sÄ… zachowywane

- SprawdÅº Å›cieÅ¼kÄ™ do artifacts (`path:`)
- Zweryfikuj czy pliki faktycznie istniejÄ… po wykonaniu testÃ³w
- Upewnij siÄ™ Å¼e uÅ¼ywasz najnowszej wersji `actions/upload-artifact`
